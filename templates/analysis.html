{% extends "base.html" %}

{% block content %}
<div class="page-header animate-fade-in">
    <h1 class="page-title">Code & Project Analysis</h1>
    <p style="color: var(--text-muted);">Analyze your GitHub projects and LeetCode performance.</p>
</div>

<div class="content-grid">
    <!-- Analysis Form -->
    <div class="glass-card animate-fade-in">
        <h2><i class="fa-brands fa-github"></i> GitHub & Course Analysis</h2>
        <div class="form-group" style="margin-top: 1rem;">
            <label>GitHub Username</label>
            <input type="text" id="gh-username" placeholder="e.g. torvalds"
                value="{{ student.data.get('github_id', '') }}">
        </div>
        <div class="form-group" style="margin-top: 1rem;">
            <label>Course / Degree</label>
            <input type="text" id="course-name" placeholder="e.g. B.Tech CSE"
                value="{{ student.data.get('degree', '') }} {{ student.data.get('specialization', '') }}">
        </div>
        <button id="analyze-btn" class="btn btn-primary" style="margin-top: 1rem; width: 100%;">
            <i class="fa-solid fa-magnifying-glass-chart"></i> Analyze Profile
        </button>
    </div>

    <!-- Results Section -->
    <div id="analysis-results" class="glass-card animate-fade-in hidden" style="grid-column: 1 / -1;">
        <div class="results-header"
            style="border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 1rem; margin-bottom: 1rem;">
            <h3>Analysis Report</h3>
            <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                <span class="badge" id="res-domain">Primary Domain: Loading...</span>
                <span class="badge" id="res-readiness">Readiness: Loading...</span>
            </div>
        </div>

        <div class="results-grid"
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
            <!-- Repos -->
            <div>
                <h4 style="color: var(--accent);">Repositories Analyzed</h4>
                <ul id="repo-list" style="list-style: none; padding: 0; margin-top: 0.5rem;">
                    <!-- Items go here -->
                </ul>
            </div>

            <!-- Gaps -->
            <div>
                <h4 style="color: #ef4444;">Missing Critical Projects</h4>
                <ul id="gaps-list" style="list-style: none; padding: 0; margin-top: 0.5rem;">
                    <!-- Items go here -->
                </ul>
            </div>

            <!-- Detected Domains -->
            <div>
                <h4 style="color: #10b981;">Detected Domains</h4>
                <div id="domain-tags" style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem;">
                </div>
            </div>

            <!-- AI Suggestions -->
            <div
                style="grid-column: 1 / -1; margin-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1.5rem;">
                <h4 style="color: #f472b6; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> Recommended Projects to Boost Profile
                </h4>
                <div id="ai-suggestions-grid"
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem;">
                    <!-- Cards injected here -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('analyze-btn').addEventListener('click', async () => {
        const btn = document.getElementById('analyze-btn');
        const resultsDiv = document.getElementById('analysis-results');

        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Analyzing...';
        resultsDiv.classList.add('hidden');

        const username = document.getElementById('gh-username').value;
        const course = document.getElementById('course-name').value;

        try {
            const response = await fetch('/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    github_username: username,
                    course: course
                })
            });

            const data = await response.json();

            if (response.ok) {
                // Populate Data
                document.getElementById('res-domain').textContent = 'Primary Domain: ' + data.primary_domain;
                document.getElementById('res-readiness').textContent = 'Readiness: ' + data.career_readiness;

                // Repos
                const repoList = document.getElementById('repo-list');
                repoList.innerHTML = '';
                if (data.projects.length === 0) {
                    repoList.innerHTML = '<li style="color: var(--text-muted);">No public repositories found.</li>';
                } else {
                    data.projects.forEach(repo => {
                        repoList.innerHTML += `
                        <li style="background: rgba(255,255,255,0.05); padding: 0.8rem; margin-bottom: 0.5rem; border-radius: 8px;">
                            <div style="font-weight: bold; color: #fff;">${repo.repo_name}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">${repo.domain} | ${repo.languages.join(', ')}</div>
                        </li>
                    `;
                    });
                }

                // Gaps
                const gapsList = document.getElementById('gaps-list');
                gapsList.innerHTML = '';
                if (data.missing_projects.length === 0) {
                    gapsList.innerHTML = '<li style="color: #10b981;">No critical gaps found! Great job.</li>';
                } else {
                    data.missing_projects.forEach(gap => {
                        gapsList.innerHTML += `
                        <li style="color: #fca5a5; margin-bottom: 0.3rem;"><i class="fa-solid fa-triangle-exclamation"></i> ${gap}</li>
                    `;
                    });
                }

                // Domains
                const domainTags = document.getElementById('domain-tags');
                domainTags.innerHTML = '';
                data.github_domains_detected.forEach(d => {
                    domainTags.innerHTML += `<span class="badge" style="background: rgba(99,102,241,0.2); color: #a5b4fc;">${d}</span>`;
                });

                // AI Suggestions
                const aiGrid = document.getElementById('ai-suggestions-grid');
                aiGrid.innerHTML = '';
                if (data.ai_suggestions && data.ai_suggestions.length > 0) {
                    data.ai_suggestions.forEach(s => {
                        aiGrid.innerHTML += `
                            <div style="background: rgba(255,255,255,0.03); padding: 1.2rem; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);">
                                <h5 style="color: #fff; font-size: 1.1rem; margin-bottom: 0.5rem;">${s.title}</h5>
                                <p style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 1rem; line-height: 1.5;">${s.description}</p>
                                <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: #f472b6; background: rgba(244, 114, 182, 0.1); padding: 0.4rem 0.8rem; border-radius: 6px; width: fit-content;">
                                    <i class="fa-solid fa-code"></i> ${s.tech}
                                </div>
                            </div>
                        `;
                    });
                } else {
                    aiGrid.innerHTML = '<p style="color: var(--text-muted); grid-column: 1/-1;">No specific AI recommendations generated.</p>';
                }

                resultsDiv.classList.remove('hidden');
            } else {
                alert('Error: ' + data.error);
            }

        } catch (e) {
            alert('Analysis failed. Please try again.');
            console.error(e);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-magnifying-glass-chart"></i> Analyze Profile';
        }
    });
</script>

<style>
    .hidden {
        display: none;
    }

    .badge {
        padding: 0.3rem 0.8rem;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        font-size: 0.8rem;
        color: white;
    }
</style>
{% endblock %}